{% extends "module_config.html.twig" %}

{% block admin_module_config_form %}
    {% if oModule.getInfo('id') == 'oxsrequestloggerremote' %}
    <style>
        .setup-workflow { margin-bottom: 20px; padding: 15px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; }
        .setup-workflow h3 { margin: 0 0 15px 0; color: #333; font-size: 14px; }
        .workflow-steps { list-style: none; padding: 0; margin: 0; }
        .workflow-steps li { padding: 8px 0; padding-left: 28px; position: relative; border-bottom: 1px solid #eee; }
        .workflow-steps li:last-child { border-bottom: none; }
        .workflow-steps li:before { content: ''; position: absolute; left: 0; top: 10px; width: 18px; height: 18px; border-radius: 50%; }
        .workflow-steps li.done:before { background: #4caf50; content: '\2713'; color: white; font-size: 12px; text-align: center; line-height: 18px; }
        .workflow-steps li.active:before { background: #2196f3; content: '\2794'; color: white; font-size: 10px; text-align: center; line-height: 18px; }
        .workflow-steps li.pending:before { background: #9e9e9e; }
        .workflow-steps li.done { color: #4caf50; }
        .workflow-steps li.active { color: #2196f3; font-weight: bold; }
        .workflow-steps li.pending { color: #9e9e9e; }
        .setup-complete { padding: 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; margin-bottom: 20px; }
        .setup-complete h3 { color: #2e7d32; margin: 0 0 5px 0; }
        /* Danger zone styles */
        .danger-zone { margin-top: 30px; padding: 20px; background: #fff3cd; border: 2px solid #dc3545; border-radius: 4px; }
        .danger-zone h3 { margin: 0 0 15px 0; color: #dc3545; font-size: 14px; }
        .danger-zone .warning-icon { font-size: 24px; margin-right: 10px; }
        .danger-zone ul { margin: 15px 0; padding-left: 20px; }
        .danger-zone li { color: #856404; margin: 8px 0; }
        .danger-zone .confirm-checkbox { margin: 15px 0; padding: 10px; background: #ffe5e5; border-radius: 4px; }
        .danger-zone .confirm-checkbox label { cursor: pointer; color: #721c24; font-weight: bold; }
        .danger-zone button { background: #dc3545; color: white; border: none; padding: 10px 20px; font-size: 14px; cursor: not-allowed; opacity: 0.5; border-radius: 4px; }
        .danger-zone button.enabled { cursor: pointer; opacity: 1; }
        .danger-zone button.enabled:hover { background: #c82333; }
        .reset-success { padding: 15px; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-bottom: 20px; }
        .reset-success h4 { color: #155724; margin: 0 0 10px 0; }
        .new-token-display { background: #f8f9fa; padding: 10px; border: 1px dashed #28a745; font-family: monospace; word-break: break-all; margin: 10px 0; }
    </style>

    {% set setupToken = confstrs['oxsrequestloggerremote_SetupToken']|default('') %}

    {% if setupToken == '' %}
        <div class="setup-complete">
            <h3>&#10004; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_COMPLETE_TITLE" }) }}</h3>
            <p style="margin: 0;">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_COMPLETE_TEXT" }) }}</p>
        </div>
    {% else %}
        <div class="setup-workflow">
            <h3>{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_TITLE" }) }}</h3>
            <ol class="workflow-steps">
                <li class="done">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_INSTALL" }) }}</li>
                <li class="done">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_MIGRATE" }) }}</li>
                <li class="done">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_ACTIVATE" }) }}</li>
                <li class="active">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_SEND_TOKEN" }) }}<br><small style="font-weight: normal;">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_SEND_TOKEN_DESC" }) }}</small></li>
                <li class="pending">{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_SETUP_STEP_WAIT_SUPPORT" }) }}</li>
            </ol>
        </div>
    {% endif %}
    {% endif %}

    {{ parent() }}

    {# Password Reset Danger Zone - only show for our module #}
    {% if oModule.getInfo('id') == 'oxsrequestloggerremote' %}
    <div class="danger-zone">
        <h3><span class="warning-icon">&#9888;</span>{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_DANGER_ZONE" }) }}</h3>
        <p>{{ translate({ ident: "OXSREQUESTLOGGERREMOTE_RESET_DESCRIPTION" }) }}</p>
        <ul>
            <li>&#10060; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_WARNING_1" }) }}</li>
            <li>&#10060; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_WARNING_2" }) }}</li>
            <li>&#10060; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_WARNING_3" }) }}</li>
            <li>&#10060; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_WARNING_4" }) }}</li>
        </ul>
        <div class="confirm-checkbox">
            <label>
                <input type="checkbox" id="confirmReset" onchange="
                    var btn = document.getElementById('resetBtn');
                    if (this.checked) {
                        btn.classList.add('enabled');
                        btn.disabled = false;
                    } else {
                        btn.classList.remove('enabled');
                        btn.disabled = true;
                    }
                ">
                {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_CONFIRM_RESET" }) }}
            </label>
        </div>
        <form method="post" action="{{ oViewConf.getSelfLink()|raw }}" onsubmit="return confirm('{{ translate({ ident: 'OXSREQUESTLOGGERREMOTE_CONFIRM_DIALOG' }) }}');">
            {{ oViewConf.getHiddenSid()|raw }}
            <input type="hidden" name="cl" value="oxsrequestloggerremote_password_reset">
            <input type="hidden" name="fnc" value="resetPassword">
            <input type="hidden" name="oxid" value="{{ oModule.getInfo('id') }}">
            <button type="submit" id="resetBtn" disabled>&#9888; {{ translate({ ident: "OXSREQUESTLOGGERREMOTE_RESET_BUTTON" }) }}</button>
        </form>
    </div>
    {% endif %}
{% endblock %}

{% block admin_module_config_var_type_str %}
    {% if module_var == 'oxsrequestloggerremote_SetupToken' %}
        <input type="text" class="txt" style="width: 350px;" name="confstrs[{{ module_var }}]" value="{{ confstrs[module_var]|raw }}" readonly onclick="
            this.select();
            document.execCommand('copy');
            var msg = document.createElement('span');
            msg.textContent = ' \u2713 {{ translate({ ident: 'OXSREQUESTLOGGERREMOTE_SETUP_COPIED' }) }}';
            msg.style.cssText = 'color: green; font-weight: bold; margin-left: 10px;';
            this.parentNode.insertBefore(msg, this.nextSibling);
            setTimeout(function() { msg.remove(); }, 2000);
        ">
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock %}
